name: C# Homework Tests

on:
  pull_request:
    paths:
      - 'homeworks/csharp-fundamentals/**/submissions/**'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    name: Validate & Test C# Submissions

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Find Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: |
            homeworks/csharp-fundamentals/**/submissions/*.cs

      - name: Validate File Names
        id: validate-files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ“‹ Dosya AdÄ± KontrolÃ¼"
          echo "===================="
          
          VALID=true
          INVALID_FILES=""
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            echo "Kontrol ediliyor: $filename"
            
            # Check format: ProblemX_123456789.cs
            if [[ ! $filename =~ ^Problem[1-4]_[0-9]{9}\.cs$ ]]; then
              echo "âŒ HATA: $filename formatÄ± yanlÄ±ÅŸ!"
              echo "   Beklenen: ProblemX_OGRENCI_NO.cs (9 haneli numara)"
              INVALID_FILES="${INVALID_FILES}- ${filename}\n"
              VALID=false
            else
              echo "âœ… Format doÄŸru: $filename"
            fi
          done
          
          if [ "$VALID" = false ]; then
            echo ""
            echo "âš ï¸ BazÄ± dosya adlarÄ± yanlÄ±ÅŸ formatta!"
            echo "invalid_files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$INVALID_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "validation_error=filename" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo ""
          echo "âœ… TÃ¼m dosya adlarÄ± doÄŸru formatta!"
          echo "validation_error=none" >> $GITHUB_OUTPUT

      - name: Run All Tests
        id: run-tests
        if: steps.changed-files.outputs.any_changed == 'true' && steps.validate-files.outcome == 'success'
        run: |
          echo "ğŸ§ª Testler BaÅŸlÄ±yor"
          echo "==================="
          
          ALL_PASSED=true
          TOTAL_SCORE=0
          DETAILED_RESULTS=""
          FAILED_TESTS=""
          
          # Track which problems were tested
          PROBLEMS_TESTED=""
          
          # Process each problem
          for problem_num in 1 2 3 4; do
            PROBLEM_DIR="homeworks/csharp-fundamentals/problem-${problem_num}"
            
            for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
              if [[ "$file" == *"problem-${problem_num}/submissions/"* ]]; then
                filename=$(basename "$file")
                student_no=$(echo "$filename" | grep -oP 'Problem[1-4]_\K\d{9}')
                
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘  Problem $problem_num - $filename"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                
                PROBLEMS_TESTED="${PROBLEMS_TESTED}${problem_num},"
                
                # Create temp project
                TEMP_DIR=$(mktemp -d)
                cp "$file" "$TEMP_DIR/Problem${problem_num}.cs"
                cp "$PROBLEM_DIR/Problem${problem_num}.Tests.cs" "$TEMP_DIR/"
                
                cd "$TEMP_DIR"
                dotnet new console -n TestProject -o . --force > /dev/null 2>&1
                
                # Run tests and capture output
                set +e
                TEST_OUTPUT=$(dotnet run -- "$filename" 2>&1)
                TEST_EXIT_CODE=$?
                set -e
                
                echo "$TEST_OUTPUT"
                
                # Parse score from output
                SCORE=$(echo "$TEST_OUTPUT" | grep -oP 'TOPLAM PUAN\s*â”‚\s*\K[\d.]+' || echo "0")
                
                # Store detailed results
                DETAILED_RESULTS="${DETAILED_RESULTS}### Problem ${problem_num}: ${filename}\n"
                DETAILED_RESULTS="${DETAILED_RESULTS}**Puan:** ${SCORE}/25\n\n"
                
                if [ "$TEST_EXIT_CODE" -ne 0 ]; then
                  ALL_PASSED=false
                  # Extract failed tests
                  FAILS=$(echo "$TEST_OUTPUT" | grep "âŒ" || true)
                  if [ -n "$FAILS" ]; then
                    FAILED_TESTS="${FAILED_TESTS}#### Problem ${problem_num}\n\`\`\`\n${FAILS}\n\`\`\`\n\n"
                  fi
                fi
                
                TOTAL_SCORE=$(echo "$TOTAL_SCORE + $SCORE" | bc)
                
                cd - > /dev/null
                rm -rf "$TEMP_DIR"
              fi
            done
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š TOPLAM SONUÃ‡: $TOTAL_SCORE / 100 puan"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Set outputs
          echo "total_score=$TOTAL_SCORE" >> $GITHUB_OUTPUT
          echo "all_passed=$ALL_PASSED" >> $GITHUB_OUTPUT
          echo "problems_tested=$PROBLEMS_TESTED" >> $GITHUB_OUTPUT
          
          # Save detailed results to file for later use
          echo -e "$DETAILED_RESULTS" > /tmp/detailed_results.txt
          echo -e "$FAILED_TESTS" > /tmp/failed_tests.txt
          
          # Exit with error if tests failed
          if [ "$ALL_PASSED" = false ]; then
            echo "test_status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "test_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Generate Job Summary
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## ğŸ“Š C# Ã–dev Test SonuÃ§larÄ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # File validation failed
          if [ "${{ steps.validate-files.outcome }}" = "failure" ]; then
            echo "### âŒ Dosya AdÄ± HatasÄ±" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "AÅŸaÄŸÄ±daki dosyalarÄ±n adlarÄ± yanlÄ±ÅŸ formatta:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate-files.outputs.invalid_files }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Beklenen format:** \`ProblemX_OGRENCI_NO.cs\` (9 haneli numara)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **PR merge edilemez.** Dosya adÄ±nÄ± dÃ¼zeltin." >> $GITHUB_STEP_SUMMARY
          
          # Tests passed
          elif [ "${{ steps.run-tests.outputs.all_passed }}" = "true" ]; then
            echo "### âœ… TÃ¼m Testler BaÅŸarÄ±lÄ±!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Toplam Puan:** ${{ steps.run-tests.outputs.total_score }} / 100" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ Tebrikler! PR merge edilebilir." >> $GITHUB_STEP_SUMMARY
          
          # Tests failed
          else
            echo "### âš ï¸ BazÄ± Testler BaÅŸarÄ±sÄ±z" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Toplam Puan:** ${{ steps.run-tests.outputs.total_score }} / 100" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show failed tests if file exists
            if [ -f /tmp/failed_tests.txt ] && [ -s /tmp/failed_tests.txt ]; then
              echo "### âŒ BaÅŸarÄ±sÄ±z Testler" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              cat /tmp/failed_tests.txt >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **PR merge edilemez.** TÃ¼m testlerin geÃ§mesi gerekiyor." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>ğŸ“‹ Puanlama Sistemi</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Problem | Konu | Max Puan |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Problem 1 | Ã–ÄŸrenci Not Hesaplama (if-else) | 25 |" >> $GITHUB_STEP_SUMMARY
          echo "| Problem 2 | GÃ¼n ve Ay Hesaplama (switch-case) | 25 |" >> $GITHUB_STEP_SUMMARY
          echo "| Problem 3 | DÃ¶ngÃ¼ler ve Matematik | 25 |" >> $GITHUB_STEP_SUMMARY
          echo "| Problem 4 | Dizi ve Liste Ä°ÅŸlemleri | 25 |" >> $GITHUB_STEP_SUMMARY
          echo "| **TOPLAM** | | **100** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“š YardÄ±m iÃ§in: [GitHub Workshop Wiki](https://github.com/Furk4nBulut/Github-Workshop/wiki)" >> $GITHUB_STEP_SUMMARY

      - name: âœ… BaÅŸarÄ±lÄ± - Yorum Ekle
        if: success() && steps.run-tests.outputs.all_passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.run-tests.outputs.total_score }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ… C# Ã–dev Testleri BaÅŸarÄ±lÄ±!

            **Toplam Puan:** ${score} / 100

            ğŸ‰ Tebrikler! TÃ¼m testler geÃ§ti. PR merge edilebilir.

            ---
            *GitHub Workshop Bot* ğŸ¤–`
            })

      - name: âŒ Dosya FormatÄ± HatasÄ± - Yorum Ekle
        if: failure() && steps.validate-files.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const invalidFiles = `${{ steps.validate-files.outputs.invalid_files }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Dosya AdÄ± HatasÄ±

            AÅŸaÄŸÄ±daki dosyalarÄ±n adlarÄ± yanlÄ±ÅŸ formatta:
            ${invalidFiles}

            **Beklenen format:** \`ProblemX_OGRENCI_NO.cs\` (9 haneli numara)

            Ã–rnek: \`Problem1_210316011.cs\`

            ---
            *GitHub Workshop Bot* ğŸ¤–`
            })

      - name: âŒ Test BaÅŸarÄ±sÄ±z - Yorum Ekle
        if: failure() && steps.validate-files.outcome == 'success' && steps.run-tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const score = '${{ steps.run-tests.outputs.total_score }}' || '0';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âš ï¸ C# Ã–dev Testleri BaÅŸarÄ±sÄ±z

            **Toplam Puan:** ${score} / 100

            BazÄ± testler geÃ§emedi. DetaylÄ± sonuÃ§lar iÃ§in:
            ğŸ‘‰ [**Workflow LoglarÄ±nÄ± Ä°ncele**](${runUrl})

            ### ğŸ’¡ Ã–neriler
            - YukarÄ±daki linke tÄ±klayarak hangi testlerin baÅŸarÄ±sÄ±z olduÄŸunu gÃ¶rÃ¼n
            - README dosyasÄ±nÄ± tekrar okuyun
            - Fonksiyon isimlerinin ve dÃ¶nÃ¼ÅŸ tiplerinin doÄŸru olduÄŸundan emin olun

            ---
            âŒ **PR merge edilemez.** TÃ¼m testlerin geÃ§mesi gerekiyor.

            ---
            *GitHub Workshop Bot* ğŸ¤–`
            })

      - name: Final Status Check
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: |
          if [ "${{ steps.validate-files.outcome }}" = "failure" ]; then
            echo "âŒ Dosya adÄ± formatÄ± yanlÄ±ÅŸ!"
            exit 1
          fi
          
          if [ "${{ steps.run-tests.outcome }}" = "failure" ]; then
            echo "âŒ BazÄ± testler baÅŸarÄ±sÄ±z!"
            exit 1
          fi
          
          echo "âœ… TÃ¼m kontroller baÅŸarÄ±lÄ±!"
